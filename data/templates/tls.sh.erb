#!/usr/bin/env bash

set -e

# generate CA key/cert
cd <%=store%>
openssl req -new -newkey rsa:2048 -days 365 -nodes -x509 -keyout ca-key.pem -out ca.pem -config ca.cnf

###################
#Server
###################
# generate server key
openssl genrsa -out server-key.pem 2048

# generate server csr
export HOST=<%=hostname%>
openssl req -subj "/CN=$HOST" -new -key server-key.pem -out server.csr

# sign server cert using the CA
echo subjectAltName = IP:10.10.10.20,IP:127.0.0.1 > server-extfile.cnf
openssl x509 -req -days 365 -in server.csr -CA ca.pem -CAkey ca-key.pem -CAcreateserial -out server.pem -extfile server-extfile.cnf

###################
#Client (Local)
###################
# export hostname of client connecting to docker server
export CLIENT_HOST=<%=client_hostname%>

# create client key
openssl genrsa -out client-key.pem 2048

# create client csr
openssl req -subj "/CN=$CLIENT_HOST" -new -key client-key.pem -out client.csr

# sign local cert
echo extendedKeyUsage = clientAuth > client-extfile.cnf
openssl x509 -req -days 365 -in client.csr -CA ca.pem -CAkey ca-key.pem -CAcreateserial -out client.pem -extfile client-extfile.cnf

chmod 600 *
mv client.pem cert.pem
mv client-key.pem key.pem
